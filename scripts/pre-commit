#!/bin/bash
# Pre-commit hook: Validates Flutter web build compiles before allowing commits
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "ğŸ” Running pre-commit build validation..."

# Check if any Dart/Flutter files are staged
DART_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(dart)$' | head -1)
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^backend/' | head -1)

if [ -n "$DART_FILES" ]; then
    echo "ğŸ“± Flutter files changed - running analyze..."
    cd app
    flutter analyze --no-fatal-infos --no-fatal-warnings 2>&1
    if [ $? -ne 0 ]; then
        echo "âŒ Flutter analyze found errors. Fix them before committing."
        exit 1
    fi
    echo "âœ… Flutter analyze passed"
    cd ..
fi

if [ -n "$BACKEND_FILES" ]; then
    echo "ğŸ–¥ï¸  Backend files changed - running TypeScript check..."
    cd backend
    npx tsc --noEmit 2>&1
    if [ $? -ne 0 ]; then
        echo "âŒ TypeScript compilation failed. Fix errors before committing."
        exit 1
    fi
    echo "âœ… Backend TypeScript check passed"
    cd ..
fi

echo "âœ… Pre-commit validation passed"
exit 0
