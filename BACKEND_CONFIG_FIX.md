# FIX: Invalid or expired token (fetch failed)

## The Problem

You're getting `"Invalid or expired token"` with `"details": "fetch failed"` when creating profile or searching.

**Root Cause**: The backend cannot connect to Supabase to validate tokens. This is NOT a token problem - it's a backend configuration/connectivity problem.

## Quick Diagnostics

### 1. Check Backend Console

Look at your backend terminal window. You should see logs like:

```
üîê Validating token...
Token length: 978
Token preview: eyJhbGciOiJFUzI1NiIs...
Supabase URL: https://your-project.supabase.co
‚ùå Token validation error: fetch failed
```

If you see "fetch failed", the backend cannot reach Supabase.

### 2. Check backend/.env File

Open `backend/.env` and verify:

```env
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6...very.long.key.here...
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6...another.long.key...
```

### 3. Compare with app/.env

The `SUPABASE_URL` in `backend/.env` MUST match `app/.env`:

```env
# app/.env
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6...
```

If they don't match, tokens generated by the frontend won't be valid for the backend!

## Common Fixes

### Fix 1: Wrong Supabase URL

**Problem**: URL in backend/.env doesn't match your actual Supabase project.

**Solution**:

1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Select your project
3. Go to **Settings** ‚Üí **API**
4. Copy the **Project URL** (looks like `https://abcdefgh.supabase.co`)
5. Update `SUPABASE_URL` in **both** `backend/.env` and `app/.env`
6. Make sure they match EXACTLY

### Fix 2: Wrong Service Role Key

**Problem**: SERVICE_ROLE_KEY is incorrect or from a different project.

**Solution**:

1. Go to Supabase Dashboard ‚Üí **Settings** ‚Üí **API**
2. Find **service_role key** (labeled "secret" - DO NOT expose!)
3. Click "Reveal" and copy the entire key
4. Update `SUPABASE_SERVICE_ROLE_KEY` in `backend/.env`
5. Make sure there are NO extra spaces or quotes

### Fix 3: Network/Firewall Blocking

**Problem**: Your network or firewall is blocking access to Supabase.

**Solution**:

1. Try accessing your SUPABASE_URL in a browser
2. It should show a JSON response (might be an error, but shouldn't be blank)
3. If it doesn't load, check:
   - Corporate firewall
   - VPN settings
   - Antivirus software
   - Windows Firewall

### Fix 4: Supabase Project Paused/Deleted

**Problem**: Your Supabase project is paused (free tier) or deleted.

**Solution**:

1. Go to Supabase Dashboard
2. Check if project shows as "Paused" or "Inactive"
3. If paused, resume it (free tier pauses after inactivity)
4. If deleted, you'll need to create a new project and update all credentials

## Step-by-Step Resolution

### Step 1: Stop Everything

```powershell
.\stop-all.ps1
```

### Step 2: Fix backend/.env

Edit `backend/.env` and ensure these values are correct:

1. **SUPABASE_URL**: Get from Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí Project URL
2. **SUPABASE_SERVICE_ROLE_KEY**: Get from Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí service_role (secret)
3. **SUPABASE_ANON_KEY**: Get from Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí anon (public)

### Step 3: Verify app/.env Matches

Edit `app/.env` and ensure:

1. **SUPABASE_URL**: Must be EXACTLY the same as backend/.env
2. **SUPABASE_ANON_KEY**: Must be the same as backend/.env

### Step 4: Restart Everything

```powershell
.\start-all.ps1
```

### Step 5: Test Again

1. Try creating/updating your profile
2. Watch the BACKEND console for logs
3. You should see: `‚úÖ Token validated for user: email@example.com`

## Verification Checklist

- [ ] SUPABASE_URL in backend/.env matches app/.env
- [ ] SUPABASE_URL is in format: `https://projectid.supabase.co` (no trailing slash)
- [ ] SUPABASE_SERVICE_ROLE_KEY starts with `eyJ` and is very long (200+ characters)
- [ ] Can access SUPABASE_URL in browser (shows JSON, even if error)
- [ ] Supabase project is active (not paused)
- [ ] Backend console shows detailed logs when API is called
- [ ] No quotes around values in .env files (just `KEY=value`, not `KEY="value"`)
- [ ] No extra spaces after = in .env files

## Expected Backend Logs (Success)

When it works, backend console should show:

```
üîê Validating token...
Token length: 978
Token preview: eyJhbGciOiJFUzI1NiIs...
Supabase URL: https://yourproject.supabase.co
‚úÖ Token validated for user: your-email@gmail.com
```

## If Still Failing

### Check These Specific Things:

1. **Network Error**:
   - Try running `curl https://yourproject.supabase.co` in terminal
   - Should get a response (even if it's an error page)
   - If timeout, it's a network/firewall issue

2. **Wrong Project**:
   - Double-check you're using keys from the SAME Supabase project
   - Frontend and backend must use the same project

3. **Typo in .env**:
   - Look for extra spaces, quotes, or line breaks
   - Values should be on same line as key: `KEY=value`
   - No comments after the value

4. **Service Role vs Anon**:
   - Backend MUST use `SUPABASE_SERVICE_ROLE_KEY` (very long, starts with eyJ)
   - Frontend uses `SUPABASE_ANON_KEY` (also long, starts with eyJ)
   - They are different keys!

## Prevention

After fixing:

1. **Document your credentials** in a secure password manager
2. **Keep .env files backed up** (but NOT in git)
3. **Test after any .env changes** by restarting services

## Success Indicator

You'll know it's fixed when:

- ‚úÖ Profile creation works without errors
- ‚úÖ Search works without "Session Expired" message
- ‚úÖ Backend logs show "Token validated for user: ..."
- ‚úÖ No "fetch failed" in error messages
