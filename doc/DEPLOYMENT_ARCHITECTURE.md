# FamilyTree Deployment Architecture

## Overview
Your FamilyTree project uses a **monorepo-to-multi-project deployment pattern**. This means:
- **1 GitHub Repository**: `ManiKumar007/FamilyTree` (monorepo containing multiple applications)
- **2 Vercel Projects**: Separate deployments for frontend and backend

This is the **correct and recommended approach** for deploying multiple applications from a single repository.

---

## Why 2 Vercel Projects for 1 GitHub Repo?

Your repository contains **two distinct applications** with different runtimes and build requirements:

### 1. Frontend Application (`/app` directory)
- **Technology**: Flutter Web (Dart)
- **Build Output**: Static HTML/CSS/JS files
- **Vercel Project**: `familytree-web` (prj_MPc1K2qT6p5qvfPAln3491b6DnAe)
- **Runtime**: Static site hosting
- **Domains**: 
  - https://familytree-web.vercel.app
  - https://familytree-web-manikumar007s-projects.vercel.app

### 2. Backend Application (`/backend` directory)
- **Technology**: Node.js/Express (TypeScript)
- **Build Output**: Serverless functions
- **Vercel Project**: `backend` (prj_FVXgxz050HYutsxQTKvLCiefInZG)
- **Runtime**: Node.js 24.x serverless functions
- **Domains**:
  - https://backend-manikumar007s-projects.vercel.app

**These MUST be separate Vercel projects** because:
1. Different runtimes (static hosting vs Node.js serverless)
2. Different build processes (Flutter vs TypeScript compilation)
3. Different deployment URLs and configurations
4. Independent scaling and monitoring

---

## Current Deployment Architecture

### Frontend Deployment Flow
```
GitHub Repo (app/ changes)
    ↓
GitHub Actions Workflow (.github/workflows/deploy-web.yml)
    ↓
1. Checkout code
2. Setup Flutter
3. Build: flutter build web --release
4. Create clean deploy/ directory
5. Copy app/build/web/* to deploy/
6. Create simplified vercel.json in deploy/
7. Deploy via Vercel CLI → familytree-web project
    ↓
Production URL: familytree-web.vercel.app
```

**Status**: ✅ Working! Latest deployment `dpl_3M1c1HfxScQimmtomdomdk8mRvFK` is READY

### Backend Deployment Flow
```
GitHub Repo (backend/ changes)
    ↓
??? (No GitHub Actions workflow exists)
    ↓
Vercel Project: backend
```

**Status**: ❌ Latest deployment `dpl_6Mx19NgfUFpBs4EdLDTJUAaYgrdd` is ERROR

---

## Configuration Files

### Frontend Configuration

#### 1. `app/vercel.json` (Original - for Vercel auto-deploy)
```json
{
  "installCommand": "git clone https://github.com/flutter/flutter.git...",
  "buildCommand": "export PATH=\"$PATH:$HOME/flutter/bin\" && bash build.sh",
  "outputDirectory": "build/web",
  "rewrites": [{"source": "/(.*)", "destination": "/index.html"}]
}
```
**Purpose**: This was used when Vercel GitHub auto-deploy was enabled. It tells Vercel how to build Flutter.

#### 2. `.github/workflows/deploy-web.yml` (Current approach)
- Builds Flutter in GitHub Actions (no Vercel build timeout)
- Creates **clean deploy/ directory** with simplified vercel.json
- Deploys via Vercel CLI with `--prod` flag
- Only triggers on changes to `app/**`, `vercel.json`, or workflow file

#### 3. `deploy/vercel.json` (Generated by workflow)
```json
{
  "version": 2,
  "routes": [
    {"handle": "filesystem"},
    {"src": "/(.*)", "dest": "/index.html"}
  ]
}
```
**Purpose**: Simple static file serving for pre-built Flutter web app.

### Backend Configuration

#### `backend/vercel.json`
```json
{
  "version": 2,
  "builds": [{"src": "dist/index.js", "use": "@vercel/node"}],
  "routes": [
    {"src": "/api/(.*)", "dest": "dist/index.js"},
    {"src": "/(.*)", "dest": "dist/index.js"}
  ]
}
```
**Purpose**: Configure serverless function deployment. All routes go to dist/index.js.

---

## Issues Discovered

### 1. Backend Has No Automated Deployment
- **Problem**: No GitHub Actions workflow for backend
- **Current State**: Backend project's latest deployment is ERROR
- **Impact**: Latest backend changes (commit 6ac1b2f - root endpoint) not deployed
- **Root Cause**: Unclear - possibly GitHub integration disconnected for backend too?

### 2. Deployment Method Inconsistency
- **Frontend**: GitHub Actions → Vercel CLI (working)
- **Backend**: Unknown deployment method (not working)

### 3. Dual vercel.json Files for Frontend
- `app/vercel.json`: Contains Flutter build commands (for Vercel auto-deploy)
- Workflow creates `deploy/vercel.json`: Simplified for static serving
- This is confusing but functional - workflow deploys from deploy/ directory

---

## Recommended Solutions

### Option A: GitHub Actions for Both (Recommended)
**Benefits**: Unified CI/CD, no Vercel build timeouts, consistent deployment logs

Create `.github/workflows/deploy-backend.yml`:
```yaml
name: Deploy Backend
on:
  push:
    branches: [master]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Build Backend
        working-directory: backend
        run: |
          npm ci
          npm run build
      - name: Deploy to Vercel
        working-directory: backend
        run: |
          npm install --global vercel@latest
          mkdir -p .vercel
          echo '{"orgId":"${{ secrets.VERCEL_ORG_ID }}","projectId":"${{ secrets.VERCEL_BACKEND_PROJECT_ID }}"}' > .vercel/project.json
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
```

**Required**: Add `VERCEL_BACKEND_PROJECT_ID` secret with value `prj_FVXgxz050HYutsxQTKvLCiefInZG`

### Option B: Vercel Auto-Deploy for Backend
**Benefits**: Automatic deployment without workflow maintenance

1. Reconnect GitHub to backend Vercel project
2. Configure **root directory**: `backend`
3. Set **build command**: `npm run build`
4. Set **output directory**: `dist`
5. Ensure backend/vercel.json is properly configured

**Downside**: Less control, potential conflicts with monorepo structure

### Option C: Keep Current (Hybrid)
- Frontend: GitHub Actions (current - working)
- Backend: Manual Vercel CLI deployment when needed

**Downside**: Manual backend deployments are tedious and error-prone

---

## GitHub Secrets Reference

Current secrets configured for frontend deployment:
- `VERCEL_TOKEN`: Vercel authentication token
- `VERCEL_ORG_ID`: `team_6wZgo0Dh5Fd6epvGlmtVsP8t`
- `VERCEL_PROJECT_ID`: `prj_MPc1K2qT6p5qvfPAln3491b6DnAe` (familytree-web)
- `SUPABASE_URL`: Supabase project URL
- `SUPABASE_ANON_KEY`: Supabase anonymous key
- `API_BASE_URL`: Backend API URL
- `APP_URL`: Frontend app URL
- `GOOGLE_CLIENT_ID`: Google OAuth client ID

**Add for backend deployment**:
- `VERCEL_BACKEND_PROJECT_ID`: `prj_FVXgxz050HYutsxQTKvLCiefInZG`

---

## Deployment Status Summary

| Component | Vercel Project | Latest Deployment | Status | Method |
|-----------|---------------|-------------------|--------|--------|
| Frontend | familytree-web | dpl_3M1c1HfxScQimmtomdomdk8mRvFK | ✅ READY | GitHub Actions |
| Backend | backend | dpl_6Mx19NgfUFpBs4EdLDTJUAaYgrdd | ❌ ERROR | Unknown |

---

## Next Steps

1. **Decide on backend deployment method** (Option A recommended)
2. **Create backend deployment workflow** if choosing GitHub Actions
3. **Deploy pending backend changes** (commit 6ac1b2f - root endpoint)
4. **Clean up app/vercel.json** (optional - not used by GitHub Actions workflow)
5. **Test both deployments** to ensure they work independently

---

## Key Takeaway

**Your setup is correct!** Having 1 GitHub repository deploy to 2 Vercel projects is the standard pattern for monorepos with multiple applications. The confusion arose because:
1. Frontend and backend are different applications with different runtimes
2. Only frontend has automated CI/CD (GitHub Actions)
3. Backend deployment method is unclear/broken

Once you set up backend deployment automation, everything will be clear and consistent.
